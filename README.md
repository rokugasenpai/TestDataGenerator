# TestDataGenerator
マスタデータの重み付けをテストデータに反映できる点をウリにしたテストデータ生成ツールです。  
データのばらつき(カーディナリティ)を想定したテストデータを生成できます。  

## 動作環境
- PHP5.4以上(PHP7動作確認済)
- Composer
- Windows・Linux・MacOSX
- 空きメモリ1GB以上

## 使い方
1. Composerがインストールされていなければインストールします。  

2. コマンドラインでcomposer installを実行します。  

3. 動作確認をします。  
コマンドラインでphp -f Example.exeを実行すると、./tdg.csvに1～1000までのシーケンス値が出力されます。  
Exmaple.phpのように引数なしでnew TDG()すると./config/tdg.jsonの設定ファイルが使用されます。  

4. 自身の設定でテストデータを生成します。  
[設定ファイルの書き方](#設定ファイルの書き方)を参考にして設定ファイルを作成します。  
new TDG()の引数に設定ファイルのパスを与えて、mainメソッドを実行します。  

## 設定ファイルの書き方
JSON(拡張子.json)またはYAML(拡張子.yml)で設定を書きます。  
JSONはphp5.4以上のjson系関数、YAMLはsymfony/yamlで解釈可能な書き方にします。  
具体的には./config/json/実際の利用を想定したユーザーテーブルデータの生成.jsonの書き方を参考にしてください。  
以下の項目を設定ファイルのルートに配置します。  

- num_data
    - 生成データ数
    - 必須
    - 正の整数
 
- record_rules
    - レコードルール
    - 必須
    - 以下の形式のフィールドごとのルールが格納されたオブジェクト  
    "フィールド名": {ルール名1: ルール値1, ルール名2: ルール値2, ...}  
    複雑なので./config以下にある設定ファイルの書かれ方も合わせて見ることをお勧めします。  
    ルール名とルール値の形式は次の通りです。  

        - seq  
        ルール値は、スカラの数値のみで、その値からはじまるシーケンス値が出力されます。  

        - number  
        ルール値は、スカラの数値か、  
        配列の[下限値, 上限値]か、[下限値, 上限値, インターバル]か、[下限値, 上限値, 重み付けの数値]です。  
        その配列を複数配列に格納することができます。  
        設定の通りに、スカラなら固定数値で、配列ならランダムな数値で出力されます。  

        - datetime  
        ルール値は、スカラの文字列であるUNIXタイムスタンプかDateTimeクラスで解釈可能な日付、  
        配列の[下限値, 上限値]か、[上限値, 下限値, 重み付けの数値]です。  
        その配列を複数配列に格納することができます。  
        設定の通りに、スカラなら固定の日付で、配列ならランダムな日付で出力されます。  

        - timestamp  
        ルール値は、スカラの文字列であるUNIXタイムスタンプかDateTimeクラスで解釈可能な日付、  
        配列の[下限値, 上限値]か、[上限値, 下限値, 重み付けの数値]です。  
        その配列を複数配列に格納することができます。  
        設定の通りに、数値がスカラなら固定タイムスタンプで、配列ならランダムなタイムスタンプで出力されます。  

        - pattern  
        ルール値は、スカラの文字列であるPattren::パターン名(Patternクラス内にあるパターンを表す変数名)、  
        配列の[パターン文字列1, パターン文字列2, ...]か、  
        [[パターン文字列1, パターン文字列2, ...], 文字列長]か、  
        [[パターン文字列1, 重み付け数値1], ...]か、  
        [[[パターン文字列1, 重み付け数値1], ...], 文字列長]です。  
        その配列を複数配列に格納することができます。  
        設定の通りに、設定にある順番で、パターンにある文字列がランダムで出力されます。  

        - master  
        ルール値は、マスタ名をキー、カラム名を値とした配列です。  
        設定の通りに、カラム名に対応する値が出力されます。  

        - code  
        ルール値は、スカラの文字列であるPHPコードです。  
        安全のため、Utilクラス、safely_evalメソッド内の  
        default_white_listで指定されたPHPトークン、関数のみ使用できます。  
        PHPコード内で出力すべき値をreturnする必要があります。  
        PHPコード内に、テストデータのフィールド名と同名の変数を使用することができます。  
        例えば、"code": "md5($user_id);"のようにランダムなユーザーIDのMD5値を得る、ということができます。  
        設定の通りに、PHPコードが返す値が出力されます。  
 
        - length  
        ルール値は、スカラの数値であるフィールドの文字列長、  
        配列の[下限値, 上限値]です。  
        patternまたはmasterがルールに含まれている場合のみ機能します。  
        各ルールにより出されたテストデータのフィールド値がlengthの範囲外だった場合は、  所定の回数リトライします。  

- output_filepath
    - 出力ファイルパス
    - デフォルト値は、./tdg.csv
    - ファイルパス文字列(相対パスも可能)

- need_null
    - NULLフィールド値フラグ
    - デフォルト値はFALSE
    - ブール
    - 出力されるテストデータのフィールド値がNULLだった場合、  
    TRUEだとNULLのまま、FALSEだと空文字に変換します。  

- masters
    - マスタファイル
    - デフォルト値は空の配列(処理なし)
    - [ファイルパス文字列, 重み付けのためのカラム名(オプション), 重み付け除数(オプション)]を格納した配列。  
    - 重み付けのためのカラム名を指定すると、重み付けを反映させたマスタデータのオブジェクトを内部的に生成します。  
    最終的にテストデータを生成する時に、そのオブジェクトから重み付けられたランダム選出を行います。  

- null_value
    - マスタファイル内NULL値
    - デフォルト値は文字列のNULL

- need_header
    - ヘッダ出力フラグ
    - 前・後処理のみ実行する場合は不要
    - デフォルト値はFALSE
    - ブール
    - ヘッダには、テストデータのフィールド名が出力されます。

- need_stdout
    - 標準出力フラグ
    - 前・後処理のみ実行する場合は不要
    - デフォルト値はFALSE
    - ブール
    - TRUEにすると生成されたテストデータが全て標準出力に出力されます。  
    件数が多い場合は、FALSEにすることをお勧めします。  

- eol
    - 出力ファイル改行コード
    - デフォルト値はPHP_EOL
    - 改行コードを表す文字列
    - 例えば、Windows上でテストデータを生成し、Linux上のDBへインポートする場合は、\nをお勧めします。

- charset
    - 出力ファイル文字コード
    - デフォルト値はUTF-8
    - 文字コードを表す文字列

- memory_limit
    - php.iniのmemory_limit
    - デフォルト値は1G
    - I/O負荷低減のためテストデータのファイル出力時に、一旦メモリ上に出力させています。  
    その際、使用できるメモリの上限値をメガバイト単位で設定します。  

## 構成
- config
    - json
        - JSON形式で書かれた設定ファイルが多数入っています。  
        これらの設定ファイルは、テストはPHPUnitによるテストでも利用されています。  
    - yml
        - YAML形式で書かれた設定ファイルが多数入っています。
    - tdg.json
        - new TDG()を引数なしで実行した際、デフォルトで読み込まれる設定ファイルです。  
        Example.phpを実行した時も読み込まれます。  
    - tdg.yml

- logs_and_coverage
    - centos67_php56
        - CentOS6.7 PHP5.6 VPSの環境でテスト実行した際の、カバレッジやベンチマーク結果などが入っています。
    - windows7_php54
        - Windows7 PHP5.4 自機の環境でテスト実行した際の、カバレッジやベンチマーク結果などが入っています。
    - windows7_php70
        - Windows7 PHP7.0 自機の環境でテスト実行した際の、カバレッジやベンチマーク結果などが入っています。

- master
    - マスタとなるCSVファイルが入っています。  
    a.csvは日本全国の郵便番号と住所と対応するおよその人口が格納されています。  
    m.csvは日本全国の名字トップ500と対応するおよその人口が格納されています。   

- src
    - プログラムソースファイルが格納されています。  
    1ファイル1クラスとなっています。  
    TDGはTDGBaseを継承しています。  
    Config > Rule、Record > Fieldの関係(継承は無し)になります。  
    Utilは独立性の高いユーティリティクラスで、WeightedArrayにのみ依存しています。  
    WeightedArrayは重み付けを考慮した配列を扱うためのクラスです。  

- tests
    - files
        - テストでのみ使用されるファイルが入っています。
    - functional
        - 機能テストのテストケースが入っています。
    - unit
        - 単体テストのテストケースが入っています。  
        UtilクラスとWeightedArrayクラスに対する単体テストができます。  

- Example.php
    - TDGクラスの使用例。  
    実行すれば、./config/tdg.jsonの設定のテストデータが生成されます。  

- Stress.php
    - 耐久テスト用。  。  
    実行すれば、2000件と100万件のテストデータが生成され、ベンチマーク結果が出力されます。

## テスト結果
単体・機能・耐久の全テストで正常に通過しています。  
今後アップデートの度に、テストを走らせ、ここに結果を書くのも大変なので、  
近いうちにVPSにJenkinsを構築しようと思います。  

## ベンチマーク結果(xdebugは無効)
- CentOS6.7 PHP5.6 CPU2.6GHz3コア メモリ2GB SSD VPS
    - Usersテーブルテストデータ2000件
        - 7秒
    - Usersテーブルテストデータ100万件
        - 27分54秒

- Windows7 PHP5.4 CPU3.3GHz2コア メモリ4GB HDD 自機
    - Usersテーブルテストデータ2000件
        - 7秒
    - Usersテーブルテストデータ100万件
        - 24分8秒

- Windows7 PHP7.0 CPU3.3GHz2コア メモリ4GB HDD 自機
    - Usersテーブルテストデータ2000件
        - 7秒
    - Usersテーブルテストデータ100万件
        - 22分23秒

## ToDo
- descriptionフィールドにあたるような文章の生成に対応させるため、  
ツイッターやブログから投稿を取得し、マスタを作ることができる仕組みを用意します。  

- 親子関係(主キー・外部キー)のあるマスタの生成に対応させます。  

- GitHubとJenkinsの連携を行います。  
GitHubへのプッシュを契機にJenkinsがPHPUnitを実行し、カバレッジなどのファイルが再プッシュされるようにします。  
