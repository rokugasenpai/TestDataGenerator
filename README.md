# TestDataGenerator
マスタデータの重み付けをテストデータに反映できる点をウリにしたテストデータ生成ツールです。  
データのばらつき(カーディナリティ)を想定したテストデータを生成できます。  
DBよりマスタデータを利用する際、ORDER BY randを使わないため、  
レコード数が多い場合に特に高速です。  

## 動作環境
- PHP5.4以上(PHP7未検証)
- Composer
- MySQL(MariaDB)
- Windows・Linux・MacOSX
- 空きメモリ1GB以上

## 使い方
1. Composerがインストールされていなければインストールします。
2. コマンドラインでcomposer installを実行します。
3. 動作確認をします。  
コマンドラインでphp -f Example.exeを実行すると、./tdg.csvに1～1000までのシーケンス値が出力されます。  
Exmaple.phpのように引数なしでnew TDG()すると./config/tdg.jsonの設定ファイルが使用されます。  
DBを使用する時には、MySQLに設定のとおりにユーザーとデータベースをそれぞれtdgで作成してください。  
4. 自身の設定でテストデータを生成します。  
[設定ファイルの書き方](#設定ファイルの書き方)を参考にして設定ファイルを作成します。  
new TDG()の引数に設定ファイルのパスを与えて実行します。  

## 設定ファイルの書き方
JSON(拡張子.json)またはYAML(拡張子.yml)で設定を書きます。  
JSONはphp5.4以上のjson系関数、YAMLはsymfony/yamlで解釈可能な書き方にします。  
以下の項目を設定ファイルのルートに配置します。  

- num_data
    - 生成データ数
    - 必須
    - 正の整数
 
- record_rules
    - レコードルール
    - 必須
    - 以下の形式のフィールドごとのルールが格納されたオブジェクト  
    "フィールド名": {ルール名1: ルール値1, ルール名2: ルール値2, ...}  
    複雑なので./config以下にある設定ファイルの書かれ方も合わせて見ることをお勧めします。  
    ルール名とルール値の形式は次の通りです。  

        - seq  
        ルール値は、スカラの数値のみで、その値からはじまるシーケンス値が出力されます。  

        - number  
        ルール値は、スカラの数値か、  
        配列の[下限値, 上限値]か、[下限値, 上限値, インターバル]か、[下限値, 上限値, 重み付けの数値]です。  
        その配列を複数配列に格納することができます。  
        設定の通りに、スカラなら固定数値で、配列ならランダムな数値で出力されます。  

        - datetime  
        ルール値は、スカラの文字列であるUNIXタイムスタンプかDateTimeクラスで解釈可能な日付、  
        配列の[下限値, 上限値]か、[上限値, 下限値, 重み付けの数値]です。  
        その配列を複数配列に格納することができます。  
        設定の通りに、スカラなら固定の日付で、配列ならランダムな日付で出力されます。  

        - timestamp  
        ルール値は、スカラの文字列であるUNIXタイムスタンプかDateTimeクラスで解釈可能な日付、  
        配列の[下限値, 上限値]か、[上限値, 下限値, 重み付けの数値]です。  
        その配列を複数配列に格納することができます。  
        設定の通りに、数値がスカラなら固定タイムスタンプで、配列ならランダムなタイムスタンプで出力されます。  

        - pattern  
        ルール値は、スカラの文字列であるPattren::パターン名(Patternクラス内にあるパターンを表す変数名)、  
        配列の[パターン文字列1, パターン文字列2, ...]か、  
        [[パターン文字列1, パターン文字列2, ...], 文字列長]か、  
        [[パターン文字列1, 重み付け数値1], ...]か、  
        [[[パターン文字列1, 重み付け数値1], ...], 文字列長]です。  
        その配列を複数配列に格納することができます。  
        設定の通りに、設定にある順番で、パターンにある文字列がランダムで出力されます。  

        - db_column  
        ルール値は、スカラの文字列であるマスタテーブルのカラム名です。  
        設定の通りに、カラム名に対応する値が出力されます。  

        - code  
        ルール値は、スカラの文字列であるPHPコードです。  
        安全のため、Utilクラス、safely_evalメソッド内の  
        default_white_listで指定されたPHPトークン、関数のみ使用できます。  
        PHPコード内で出力すべき値をreturnする必要があります。  
        PHPコード内に、テストデータのフィールド名と同名の変数を使用することができます。  
        例えば、"code": "md5($user_id);"のようにランダムなユーザーIDのMD5値を得る、ということができます。  
        設定の通りに、PHPコードが返す値が出力されます。  
 
        - length  
        ルール値は、スカラの数値であるフィールドの文字列長、  
        配列の[下限値, 上限値]です。  
        patternまたはdb_columnがルールに含まれている場合のみ機能します。  
        各ルールにより出されたテストデータのフィールド値がlengthの範囲外だった場合は、  所定の回数リトライします。  

- output_filepath
    - 出力ファイルパス
    - デフォルト値は、./tdg.csv
    - ファイルパス文字列(相対パスも可能)

- db_pass
    - DBパスワード
    - DBよりマスタデータを利用する場合は必須
    - 文字列

- sql
    - SQL
    - DBよりマスタデータを利用する場合は必須
    - 文字列
    - limit句はプログラム内で付加されるため、設定内では書きません。

- need_null
    - NULLフィールド値フラグ
    - デフォルト値はFALSE
    - ブール
    - 出力されるテストデータのフィールド値がNULLだった場合、  
    TRUEだとNULLのまま、FALSEだと空文字に変換します。  

- num_records_per_sql
    - 1SQLあたりの件数
    - デフォルト値は1000
    - 正の整数
    - 前・後処理のバルクインサート数、およびデータ生成時の1回のクエリで取得する件数。

- pre_proc
    - 前処理用ファイル
    - デフォルト値は空の配列(処理なし)
    - 前処理用ファイル(マスタデータ取り込み用CSV/SQLなど)のファイルパス文字列、  
    または、[ファイルパス文字列, 重み付けのためのカラム名, 生成レコード数]を格納した配列。  
    - 重み付けのためのカラム名を指定すると、マスタデータに対し重み付けを反映させた  
    中間的なマスタデータを生成し、DBのテーブルへINSERTさせることができます。  

- post_proc
    - 後処理用ファイル
    - デフォルト値は空の配列(処理なし)
    - 後処理用ファイルのファイルパス文字列を格納した配列

- proc_null_value
    - 前・後処理用ファイル内NULL値
    - デフォルト値は文字列のNULL

- proc_head_sql
    - 前・後処理用先頭SQL
    - デフォルト値は空文字
    - SET文などを先頭に挿入するために設定します。  
    前・後処理用ファイルがCSVの時のみ機能します。  

- proc_tail_sql
    - 前・後処理用末尾SQL
    - デフォルト値は空文字
    - OPTIMIZE TABLE文などを末尾に挿入するために設定します。  
    前・後処理用ファイルがCSVの時のみ機能します。  

- db_name
    - DB名
    - デフォルト値はtdg
 
- db_user
    - DBユーザー名
    - デフォルト値はroot

- db_host
    - DBホストアドレス
    - デフォルト値はlocalhost

- db_port
    - DBホストポート
    - デフォルト値は3306

- need_header
    - ヘッダ出力フラグ
    - デフォルト値はFALSE
    - ブール
    - ヘッダには、テストデータのフィールド名が出力されます。

- need_stdout
    - 標準出力フラグ
    - デフォルト値はFALSE
    - ブール
    - TRUEにすると生成されたテストデータが全て標準出力に出力されます。  
    件数が多い場合は、FALSEにすることをお勧めします。  

- eol
    - 出力ファイル改行コード
    - デフォルト値はPHP_EOL
    - 改行コードを表す文字列
    - 例えば、Windows上でテストデータを生成し、Linux上のDBへインポートする場合は、\nをお勧めします。

- charset
    - 出力ファイル文字コード
    - デフォルト値はUTF-8
    - 文字コードを表す文字列

- memory_limit
    - php.iniのmemory_limit
    - デフォルト値は1G
    - I/O負荷低減のためテストデータのファイル出力時に、一旦メモリ上に出力させています。  
    その際、使用できるメモリの上限値をメガバイト単位で設定します。  

## 構成
- config
    - json
        - JSON形式で書かれた設定ファイルが多数入っています。  
        これらの設定ファイルは、テストはPHPUnitによるテストでも利用されています。  
    - yml
        - YAML形式で書かれた設定ファイルが多数入っています。
    - tdg.json
        - new TDG()を引数なしで実行した際、デフォルトで読み込まれる設定ファイルです。  
        Example.phpを実行した時も読み込まれます。  
    - tdg.yml

- logs_and_coverage
    - centos67_php56
        - CentOS6.7 PHP5.6 VPSの環境でテスト実行した際の、カバレッジやベンチマーク結果などが入っています。
    - windows7_php54
        - Windows7 PHP5.4 自機の環境でテスト実行した際の、カバレッジやベンチマーク結果などが入っています。

- proc
    - 前・後処理で使われるCSVファイルやSQLファイルが入っています。  
    a.csvは日本全国の郵便番号と住所と対応するおよその人口が格納されています。  
    m.csvは日本全国の名字トップ500と対応するおよその人口が格納されています。   

- src
    - プログラムソースファイルが格納されています。  
    1ファイル1クラスとなっています。  
    TDGはTDGBaseを継承しています。  
    Config > Rule、Record > Fieldの関係(継承は無し)になります。  
    Utilは独立性の高いユーティリティクラスで、WeightedArrayにのみ依存しています。  
    WeightedArrayは重み付けを考慮した配列を扱うためのクラスです。  

- tests
    - files
        - テストでのみ使用されるファイルが入っています。
    - functional
        - 機能テストのテストケースが入っています。
    - unit
        - 単体テストのテストケースが入っています。  
        UtilクラスとWeightedArrayクラスに対する単体テストができます。  

- Example.php
    - TDGクラスの使用例。  
    実行すれば、./config/tdg.jsonの設定のテストデータが生成される。  

- Stress.php
    - 耐久テスト用。  。  
    実行すれば、2000件と100万件のテストデータが生成され、ベントマーク結果が出力される。

## テスト結果
単体・機能・耐久の全テストで正常に通過しています。  
今後アップデートの度に、テストを走らせ、ここに結果を書くのも大変なので、  
近いうちにVPSにJenkinsを構築しようと思います。  

## ベンチマーク結果
- CentOS6.7 PHP5.6 CPU2.6GHz3コア メモリ2GB SSD VPS
    - Usersテーブルテストデータ2000件
        - xdebug有効
            - 14分19秒 
        - xdebug無効
            - 2分29秒
    - Usersテーブルテストデータ100万件
        - xdebug有効
            - 未計測
        - xdebug無効
            - 未計測

- Windows7 PHP5.4 CPU3.3GHz2コア メモリ4GB HDD 自機
    - Usersテーブルテストデータ2000件
        - xdebug有効
            - 3分11秒
        - xdebug無効
            - 1分33秒
    - Usersテーブルテストデータ100000件
        - xdebug有効
            - 未計測
        - xdebug無効
            - 1時間19分51秒

## ToDo
- Utilクラスのsafely_evalメソッドの改修を行います。  
ブレーカー処理をmax_code_strlenを基準に行うではなく、  
reactphp/promiseを使ってeval()を非同期実行させることで、処理時間を基準に行います。  
また、ホワイトリストの関数に日付系関数がないため、追加します。  

- TDGのコンストラクタ引数に直接設定の配列を渡せるように改修します。

- 設定項目return_dataを追加し、TRUEの場合はテストデータを配列で返すように改修します。

- descriptionフィールドにあたるような文章の生成に対応させるため、  
ツイッターやブログから投稿を取得し、マスタデータを作ることができる仕組みを用意します。  

- 親子関係(主キー・外部キー)のあるマスタデータの生成に対応させます。  

- GitHubとJenkinsの連携を行います。  
GitHubへのプッシュを契機にJenkinsがPHPUnitを実行し、カバレッジなどのファイルが再プッシュされるようにします。  

- PHP7で問題のある箇所(foreachでの破壊的操作など)を修正します。  
